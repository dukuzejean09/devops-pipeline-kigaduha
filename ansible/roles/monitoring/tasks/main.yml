---
# Monitoring Configuration Tasks

- name: Install monitoring tools
  apt:
    name:
      - prometheus-node-exporter
      - sysstat
    state: present
  when: ansible_os_family == "Debian"

- name: Start and enable node exporter
  service:
    name: prometheus-node-exporter
    state: started
    enabled: yes

- name: Create monitoring scripts directory
  file:
    path: /opt/monitoring
    state: directory
    mode: '0755'

- name: Deploy health check script
  copy:
    dest: /opt/monitoring/health_check.sh
    content: |
      #!/bin/bash
      # Health check script for DevOps Pipeline
      
      # Check Docker service
      systemctl is-active --quiet docker || echo "Docker service is not running"
      
      # Check containers
      docker ps --format "{{.Names}}: {{.Status}}" | grep -E "devops-frontend|devops-backend"
      
      # Check disk space
      df -h | grep -v tmpfs
      
      # Check memory usage
      free -h
    mode: '0755'

- name: Set up log rotation
  copy:
    dest: /etc/logrotate.d/devops-pipeline
    content: |
      /var/log/devops-pipeline/*.log {
          daily
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 {{ app_user }} {{ app_user }}
          sharedscripts
          postrotate
              systemctl reload docker > /dev/null 2>&1 || true
          endscript
      }
    mode: '0644'
